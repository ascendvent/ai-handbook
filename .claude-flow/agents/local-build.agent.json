{
    "name": "Local Dev Build Agent",
    "description": "Runs full clean local Docker build and health check before commit to ensure stable code.",
    "triggers": [
        "manual",
        "pull_request",
        "push:feature/*"
    ],
    "actions": [
        {
            "type": "run_shell_command",
            "command": "docker-compose down --volumes --remove-orphans",
            "message": "🧹 Cleaned up old containers, networks, and volumes."
        },
        {
            "type": "run_shell_command",
            "command": "docker-compose build --no-cache",
            "fail_on_error": true,
            "message": "❌ Clean Docker build failed. See ./docs/bugs/local-build-log.txt for details.",
            "on_fail": {
                "log_file": "./docs/bugs/local-build-log.txt"
            }
        },
        {
            "type": "run_shell_command",
            "command": "docker-compose up -d --force-recreate",
            "fail_on_error": true,
            "message": "❌ Local Docker services failed to start. See ./docs/bugs/local-run-log.txt.",
            "on_fail": {
                "log_file": "./docs/bugs/local-run-log.txt"
            }
        },
        {
            "type": "run_smoke_tests",
            "tests": [
                {
                    "name": "Local Health Check",
                    "command": "curl -f http://localhost:3000/api/health || exit 1"
                }
            ],
            "on_fail": {
                "log_file": "./docs/bugs/local-health-log.txt",
                "log_bug": "🚫 Local service failed health check before commit."
            }
        },
        {
            "type": "run_shell_command",
            "command": "docker-compose logs --tail=100 > ./docs/bugs/local-service-logs.txt",
            "message": "📄 Captured last 100 lines of service logs."
        },
        {
            "type": "run_shell_command",
            "command": "docker-compose down",
            "message": "🛑 Local Docker environment stopped."
        }
    ]
}